JSONGEN_VERSION = @PACKAGE_VERSION@

SOURCES = $(notdir $(wildcard src/*.erl)) jsg_regexp_parser.erl
BEAMS = $(patsubst %.erl,ebin/%.beam,$(SOURCES))

LINKTESTS = $(notdir $(wildcard link_tests/*.erl)) 
LINKBEAMS = $(patsubst %.erl,link_tests/ebin/%.beam,$(LINKTESTS))

EFLAGS = +debug_info -D JSONGEN_VERSION=\"$(JSONGEN_VERSION)\"

all: ebin $(BEAMS)

main: ${BEAMS}

clean:
	rm -f ebin/*.beam link_tests/ebin/*.beam src/regexp_parser.erl

src/jsg_regexp_parser.erl: src/jsg_regexp_parser.yrl
	(cd src; erl -noshell -run yecc file jsg_regexp_parser.yrl -run erlang halt)

ebin/%.beam: src/%.erl src/jsongen.hrl
	erlc $(EFLAGS) -o ebin $<

ebin:
	mkdir -p ebin

docs:
	make edoc

edoc: 
	mkdir -p doc/doc
	cp doc/overview.edoc doc/doc
	erl -noshell -run edoc_run files '["src/jsongen.erl", "src/jsg_json_validate.erl","src/jsg_json.erl","src/jsg_jsonschema.erl"]' '[{sort_functions,false},{dir,"doc/doc"}]'

dialyzer:
	dialyzer ebin/*beam

release: main docs
	@ scripts/mkrelease "." release $(JSONGEN_VERSION)

install: release
	@ scripts/dorelease "." release $(JSONGEN_VERSION)

link_testing: link_tests/ebin $(LINKBEAMS) 

link_tests/ebin:
	mkdir -p link_tests/ebin

link_tests/ebin/%.beam: link_tests/%.erl src/jsongen.hrl
	erlc $(EFLAGS) -o link_tests/ebin $<

dotest:
	erl -pa ebin -noshell -run jsg_rtest test -run erlang halt
